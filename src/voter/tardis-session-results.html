<link rel="import" href="../../bower_components/polymer/polymer.html">
<!--<link rel="import" href="../../bower_components/google-chart/google-chart.html">-->


<script src="//d3js.org/d3.v4.min.js"></script>

<dom-module id="tardis-session-results">
  <template>
    <style include="iron-flex">
      :host {
        display: block;
        /*position: fixed;*/
        /*top: 0;*/
        /*bottom: 0;*/
        /*left: 0;*/
        /*right: 0;*/
        /*padding-top: 64px;*/
      }

      /*google-chart {*/
        /*@apply(--layout-flex);*/
        /*width: auto;*/
        /*height: 100vh;*/
      /*}*/

      .bar {
        fill: steelblue;
        width: 50px;
        height: 50px;
      }

      .axis path {
        display: none;
      }

      #chart {
        /*background: gray;*/
        /*overflow-y: auto;*/
      }

      /*text.title {*/
        /*color: white;*/
      /*}*/

    </style>



    <!--<svg id="svg" width="960" height="500"></svg>-->
    <div id="chart"></div>
  </template>

  <script>


  </script>

  <script>
    function columnSum (data, columns) {
      return columns.reduce(function (pre, curr) {
        return pre + data[curr];
      }, 0);
    }

    Polymer({
      is: 'tardis-session-results',

      properties: {
        id: {
          type: String,
          observer: '_sessionChanged'
        },
        votes: {
          type: Object,
          observer: '_votesChanged'
        },
        sessions: {
          type: Object
        },
        chartData: {
          value: [
            ["Session", "Cool", "OK", "No"],
            ["2010", 10, 24, 20],
            ["2020", 16, 22, 23],
            ["2030", 28, 19, 29]
          ]
        },
        chartData1: {
          value: []
        }
      },

      observers: [
        '_chartDataChanged(chartData1.splices)'
      ],

      _chartDataChanged: function (splice) {
        if (splice) {
//          console.log(splice.indexSplices[splice.indexSplices.length - 1].object);
        }
//        console.log('FFFF', splice);
      },

      ready: function () {
        this.votesRef = firebase.app('tardis').database().ref('/votes');
        this.sessionsRef = firebase.app('tardis').database().ref('/sessions');


        var _this = this;

        this.sessionsRef.on('value', function (snapshot) {
          _this.sessions = snapshot.val();
        });

        this.votesRef.on('value', function(snapshot) {
          _this.votes = snapshot.val();
        });



      },

      _render: function (data) {

        var svg= d3.select('#chart')
          .append('svg')
          .attr('width', '100%')
//          .attr('width', w)
          .attr('height', 1500);

        var session = svg.selectAll('rect.colorBar')
          .data(data)
          .enter()
          .append('g');

//        session.append("g")
//          .style("text-anchor", "end")
//          .attr("transform", "translate(-6," + height / 2 + ")");

        session.append("text")
//          .style("text-anchor", "end")
          .style("fill", "white")
//          .attr("transform", "translate(0, 40)")
          .attr("class", "title")
          .text(function(d) { return d.title; })
          .attr('y', function(d,i){
            return i * (25 + 2) - 4;
          })
        ;

        var columnMapping = {
          cool: { barColor: 'green' },
          okay: { barColor: 'gray' },
          no: { barColor: 'red' }
        };

        var columns = Object.keys(columnMapping);

        columns.forEach(function (columnKey, columnI) {
          var column = columnMapping[columnKey];

          session
            .append('rect')
            .attr('width', function(d,i){
              var sum = columnSum(d, columns);
              return ( sum ? (100.0 * d[columnKey] / sum) : 0) + '%';
            })
            .attr('height', function(d,i){
              return 25;
            })
            .attr('x', function(d,i){
              var x = columnSum(d, columns.slice(0, columnI));
              var sum = columnSum(d, columns);

              return ( sum ? (100.0 * x / sum) : 0) + '%';
            })
            .attr('y', function(d,i){
              return i * (25 + 2)
            })
            .attr('fill', column.barColor);
        });
      },

      _votesChanged: function(newValue) {
//        console.log(newValue);

        this.chartData = [
          [ "Session", "Cool", "OK", "No" ]
        ];
        for( var key in this.votes) {
//          var sess = {};
//          console.log(key);
          var line = [this.sessions[key].title];
          var vs = this.votes[key];
          var cool = 0;
          var okay = 0;
          var no = 0;

          for(var i in vs) {
            var v = vs[i].value;

            cool = v === 1 ? cool + 1 : cool;
            okay = v === 0 ? okay + 1 : okay;
            no = v === -1 ? no + 1 : no;
          }

          line.push(cool);
          line.push(okay);
          line.push(no);

          var sess = {
            title: this.sessions[key].title,
            cool: cool,
            okay: okay,
            no: no
          };

//          console.log(line);

          this.push('chartData1', sess);
//          this.set()
          this.chartData.push(line);
        }

        this._render(this.chartData1);
console.log(this.chartData1);
      },

      _sessionChanged: function(newValue) {
        this.sessionVotesRef = this.votesRef.child(newValue);
      }
    });
  </script>
</dom-module>
