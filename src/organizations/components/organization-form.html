<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">

<!--<link rel="import" href="/bower_components/paper-toast/paper-toast.html">-->

<dom-module id="organization-profile-form">
  <template>
    <style include="iron-flex">
      :host {
        display: block;
      }
    </style>

    <!--<paper-toast id="toast" horizontal-align="right" vertical-align="top" vertical-offset="90"></paper-toast>-->

      <paper-icon-button icon="icons:save" on-tap="handleSave"></paper-icon-button>
      <paper-icon-button icon="icons:load" on-tap="handleReset"></paper-icon-button>
      <!--<paper-icon-button icon="icons:delete" on-tap="destroy"></paper-icon-button>-->

      <paper-input label="Name" value="{{data.name}}"></paper-input>

      <div>
        <img height="100" src="[[data.logoUrl]]" on-click="handleChangeLogo" />
      </div>

      <input type="file" id="logoFile" on-change="handleFile">

      <paper-input label="Company URL" value="{{data.url}}"></paper-input>
  </template>

  <script>
    class OrganizationProfileForm extends Polymer.Element {
      static get is() {
        return 'organization-profile-form'
      }

      static get properties() {
        return {
          organization: Object,
          data: {
            type: Object,
            value: {}
          }
        };
      }

      static get observers() {
        return [
          '_dataChanged(organization)'
        ];
      }

      _dataChanged (organization) {
        this.data = Object.assign({}, organization);

      }

      handleSave () {
        this.dispatchEvent(new CustomEvent('save', { detail: this.data }));
      }

      handleChangeLogo () {
        console.log('handleChangeLogo');
      }

      handleReset () {
        this.$.logoFile.value = null;
      }

      handleFile (ev) {
        if (ev.target && ev.target.files.length) {
          const file = ev.target.files[0];

          const timestamp = `${Date.now()}${new Date().getUTCMilliseconds()}`;

          const storageRef = firebase.storage().ref('/images/organizations/');
          const metadata = {
            contentType: file.type,
            customMetadata: {
              dbRef: '/organizations/1/logoUrl' ,
            },
          };

          storageRef
            .child(file.name.replace(/^.*(\.[^.]*)$/, `${timestamp}_original$1`))
            .put(file, metadata)
            .then(snapshot => {
              console.log('Uploaded', snapshot.totalBytes, 'bytes.');
              console.log(snapshot.metadata);
              var url = snapshot.downloadURL;
              console.log('File available at', url);
              // [START_EXCLUDE]
//              document.getElementById('linkbox').innerHTML = '<a href="' +  url + '">Click For File</a>';
              // [END_EXCLUDE]
            })
            .catch(error => {
              // [START onfailure]
              console.error('Upload failed:', error);
              // [END onfailure]
            });
            // [END oncomplete]
        }
      }
    }

    customElements.define(OrganizationProfileForm.is, OrganizationProfileForm);
  </script>

</dom-module>
