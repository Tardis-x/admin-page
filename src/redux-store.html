<link rel="import" href="/bower_components/polymer-redux/polymer-redux.html">

<script>
  const initialState = {
    auth: {
      user: undefined,
      error: undefined,
    },
    speakers: {
      speakers: [],
      speaker: undefined
    },
  };

  const speakersReducer = (state, action) => {
    switch (action.type) {
      case 'FETCH_SPEAKERS_SUCCESS':
        const speakers = Object.keys(action.data)
          .map(key => Object.assign({}, action.data[key], { $key: key }) );

        return Object.assign({}, state, { speakers });

      case 'FETCH_SPEAKER':
        return state;

      case 'FETCH_SPEAKER_SUCCESS':
      case 'UPDATE_SPEAKER_SUCCESS':
        const speaker = action.data;
        return Object.assign({}, state, { speaker });

      default:
        return state;
    }
  };

  const authReducer = (state, action) => {
    switch (action.type) {
      case 'SIGNIN_SUCCESS':
        const user = action.data;
        return Object.assign({}, state, { user });

      case 'SIGNIN_FAILURE':
        const auth = action.data;
        return Object.assign({}, state, auth);

      case 'SIGNOUT_SUCCESS':
        return Object.assign({}, state, { user: undefined });

      default:
        return state;
    }
  };

  const appReducer = (state, action) => {
    if (!state) return initialState;

    return {
      auth: authReducer(state.auth, action),
      speakers: speakersReducer(state.speakers, action),
    };
  };

  const store = Redux.createStore(appReducer);
  const ReduxMixin = PolymerRedux(store);

//  firebase.database().ref('/speakers').on('value', snapshot => {
//    store.dispatch({
//      type: 'FETCH_SPEAKERS',
//      data: snapshot.val()
//    });
//  });

  const speakerActions = {
    fetchSpeakers: () => {
      firebase.database().ref('/speakers').once('value', snapshot => {
        store.dispatch({
          type: 'FETCH_SPEAKERS_SUCCESS',
          data: snapshot.val()
        });
      });
    },
    fetchSpeaker: (key) => {
      firebase.database().ref(`/speakers/${key}`).once('value', snapshot => {
        store.dispatch({
          type: 'FETCH_SPEAKER_SUCCESS',
          data: snapshot.val()
        });
      });
    },
    updateSpeaker: (key, data) => {
      firebase.database().ref(`/speakers/${key}`).set(data);
      speakerActions.fetchSpeaker(key);
    },
  };

  const authActions = {
    provider: new firebase.auth.GoogleAuthProvider(),
    getCurrentUser: function () {
        console.log('getCurrentUser');
      const user = firebase.auth().currentUser;
      console.log('getCurrentUser', user);
      if (user) {
        store.dispatch({
          type: 'SIGNIN_SUCCESS',
          data: user,
        });
      } else {
        store.dispatch({
          type: 'SIGNIN_SUCCESS',
          data: user,
        });
      }
    },
    signIn: function () {
      firebase.auth().signInWithPopup(this.provider)
        .then(result => {
          store.dispatch({
            type: 'SIGNIN_SUCCESS',
            data: result.user,
          });
        })
        .catch(error => {
          store.dispatch({
            type: 'SIGNIN_FAILURE',
            data: error,
          });
        });
    },
    signOut: function () {
      firebase.auth().signOut()
        .then(() => {
          this.getCurrentUser();
        })
        .catch(error => {
          store.dispatch({
            type: 'SIGNIN_FAILURE',
            data: error,
          });
        });
    },
  };
</script>
