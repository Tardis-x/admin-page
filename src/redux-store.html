<link rel="import" href="/bower_components/polymer-redux/polymer-redux.html">

<script>
  const initialState = {
    speakers: {
      speakers: [],
      speaker: undefined
    }
  };

  const speakersReducer = (state, action) => {
    switch (action.type) {
      case 'FETCH_SPEAKERS_SUCCESS':
        const speakers = Object.keys(action.data)
          .map(key => Object.assign({}, action.data[key], { $key: key }) );

        return Object.assign({}, state, { speakers });

      case 'FETCH_SPEAKER':
        return state;

      case 'FETCH_SPEAKER_SUCCESS':
        const speaker = action.data;
        return Object.assign({}, state, { speaker });
    }
  };

  const appReducer = (state, action) => {
    if (!state) return initialState;

    const speakers = speakersReducer(state.speakers, action);

    return { speakers }
  };

  const store = Redux.createStore(appReducer);
  const ReduxMixin = PolymerRedux(store);

//  firebase.database().ref('/speakers').on('value', snapshot => {
//    store.dispatch({
//      type: 'FETCH_SPEAKERS',
//      data: snapshot.val()
//    });
//  });

  const speakerActions = {
    fetchSpeakers: () => {
      firebase.database().ref('/speakers').once('value', snapshot => {

        store.dispatch({
          type: 'FETCH_SPEAKERS_SUCCESS',
          data: snapshot.val()
        });
      });
    },

    fetchSpeaker: (key) => {
      firebase.database().ref(`/speakers/${key}`).once('value', snapshot => {
        store.dispatch({
          type: 'FETCH_SPEAKER_SUCCESS',
          data: snapshot.val()
        });
      });
    }
  }
</script>
